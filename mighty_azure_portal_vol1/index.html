<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Mighty Azure portal vol1 - Doctor Solution</title>
        <meta name="Description" content=""><meta property="og:title" content="Mighty Azure portal vol1" />
<meta property="og:description" content="
How many times did you find yourself in need to do some repetitive tasks on Windows Servers? Since 2006. when PowerShell first appeared, a lot has changed. We&rsquo;ve been writing scripts, functions, and all the code that could help us in order to ease some Admin pain and speed up things.
With PowerShell 2 came PS remoting, so we were able to execute commands on other servers too.
How do you manage certain things today in the era of Cloud? Let me guide you through one simple how-to." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://doctorsolution.xyz/mighty_azure_portal_vol1/" />
<meta property="article:published_time" content="2020-05-08T21:16:50+02:00" />
<meta property="article:modified_time" content="2020-05-09T03:11:39+02:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mighty Azure portal vol1"/>
<meta name="twitter:description" content="
How many times did you find yourself in need to do some repetitive tasks on Windows Servers? Since 2006. when PowerShell first appeared, a lot has changed. We&rsquo;ve been writing scripts, functions, and all the code that could help us in order to ease some Admin pain and speed up things.
With PowerShell 2 came PS remoting, so we were able to execute commands on other servers too.
How do you manage certain things today in the era of Cloud? Let me guide you through one simple how-to."/>
<meta name="application-name" content="Doctor Solution">
<meta name="apple-mobile-web-app-title" content="Doctor Solution"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://doctorsolution.xyz/mighty_azure_portal_vol1/" /><link rel="prev" href="https://doctorsolution.xyz/azure_application_gateway_reconfiguration/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Mighty Azure portal vol1",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/doctorsolution.xyz\/mighty_azure_portal_vol1\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/doctorsolution.xyz\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "Azure, PowerShell","wordcount":  561 ,
        "url": "https:\/\/doctorsolution.xyz\/mighty_azure_portal_vol1\/","datePublished": "2020-05-08T21:16:50+02:00","dateModified": "2020-05-09T03:11:39+02:00","publisher": {
                "@type": "Organization",
                "name": "xxxx",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/doctorsolution.xyz\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"author": {
                "@type": "Person",
                "name": "Milos Katinski"
            },"description": ""
    }
    </script></head>
    <body><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Doctor Solution">Doctor Solution</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Doctor Solution">Doctor Solution</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Mighty Azure portal vol1</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Milos Katinski</a></span>&nbsp;
                    <span class="post-category">included in<a href="/categories/tips-and-tricks/">
                                <i class="far fa-folder fa-fw"></i>Tips and Tricks
                            </a>&nbsp;<a href="/categories/azure/">
                                <i class="far fa-folder fa-fw"></i>Azure
                            </a>&nbsp;<a href="/categories/how-to-configure/">
                                <i class="far fa-folder fa-fw"></i>How to configure
                            </a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-05-08>2020-05-08</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>about 561 words&nbsp;
                <i class="far fa-clock fa-fw"></i>3 min&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading/normal.min.svg"
        data-src="/images/powershell-icon.webp"
        data-srcset="/images/powershell-icon.webp, /images/powershell-icon.webp 1.5x, /images/powershell-icon.webp 2x"
        data-sizes="auto"
        alt="/images/powershell-icon.webp"
        title="/images/powershell-icon.webp" /></div><div class="details toc" id="toc-static">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><!-- Your front matter up here -->
<p>How many times did you find yourself in need to do some repetitive tasks on Windows Servers? Since 2006. when PowerShell first appeared, a lot has changed. We&rsquo;ve been writing scripts, functions, and all the code that could help us in order to ease some Admin pain and speed up things.
With PowerShell 2 came PS remoting, so we were able to execute commands on other servers too.</p>
<p>How do you manage certain things today in the era of Cloud? Let me guide you through one simple how-to.</p>
<p>After spinning a certain infrastructure in Azure, based on IaaS, I was asked to create a couple of local admin users on each VM. It would be ok if there weren&rsquo;t 10+ VMs at the start. Without even logging in to the first, I decided to try to automate the task as much as possible and again to use the security guidelines that we agreed upon.</p>
<p>When you go to the VM, under &ldquo;Operations&rdquo; there is a &ldquo;Run command&rdquo; which, among other things, gives you the option to execute a PowerShell script directly from Portal. Easy and powerful. But this is just a start.</p>
<p>I had to use Secrets stored in KeyVault. No problem, there is a straight PS command that can do that. But how will my VM access the protected KeyVault (Networking set to use Private endpoint and selected networks, Access policies hardening who/what can even read data)? Well, it needs to authenticate somehow. If we look at our VM again, under &ldquo;Settings&rdquo; there is an &ldquo;Identity&rdquo; option. Here you can activate System assigned managed identity which will enable our VM to authenticate to e.g KeyVault.
After enabling this option, you will have an object that you can add in KeyVault Access Policies with desired permissions. Great, now our VM can grab the data it needs.</p>
<p>Now, in already mentioned VM Run Command we should be able to execute the script.</p>
<details>
    <summary markdown="span">Add-AzureVMLocalUser.ps1</summary>
<div class="highlight"><pre class="chroma"><code class="language-powershell" data-lang="powershell"><span class="cm">&lt;# If you haven&#39;t previously logged to VM and install any module, this is mandatory,else
</span><span class="cm">our script will hang forever because &#34;Run Command&#34; doesn&#39;t ask for confirmation when needed #&gt;</span>
<span class="nb">Set-PSRepository</span> <span class="n">-Name</span> <span class="n">PSGallery</span> <span class="n">-InstallationPolicy</span> <span class="n">Trusted</span>

<span class="cm">&lt;#This command is needed on Windows Server 2016 - You will first have to install Nuget package
</span><span class="cm">which is refusing default Tls1.0 #&gt;</span>
<span class="no">[Net.ServicePointManager]</span><span class="p">::</span><span class="n">SecurityProtocol</span> <span class="p">=</span> <span class="no">[Net.SecurityProtocolType]</span><span class="p">::</span><span class="n">Tls12</span>
<span class="nb">Install-PackageProvider</span> <span class="n">-Name</span> <span class="n">NuGet</span> <span class="n">-MinimumVersion</span> <span class="n">2</span><span class="p">.</span><span class="n">8</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">201</span> <span class="n">-Force</span>

<span class="nb">Install-Module</span> <span class="n">Az</span>

<span class="cm">&lt;#Here we use previously enabled Managed identity to login to our Azure subscription #&gt;</span>
<span class="nb">Connect-AzAccount</span> <span class="n">-Identity</span>

<span class="nv">$vaultName</span> <span class="p">=</span> <span class="s2">&#34;ENTER VAULT NAME HERE&#34;</span>
<span class="nv">$user</span> <span class="p">=</span> <span class="s2">&#34;AdminUsername&#34;</span> <span class="c"># change with your KeyVault data</span>
<span class="nv">$pass</span> <span class="p">=</span> <span class="s2">&#34;AdminPassword&#34;</span>

<span class="nv">$username</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-AzKeyVaultSecret</span> <span class="n">-VaultName</span> <span class="nv">$vaultName</span> <span class="n">-Name</span> <span class="nv">$user</span><span class="p">).</span><span class="n">SecretValueText</span>

<span class="nv">$password</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-AzKeyVaultSecret</span> <span class="n">-VaultName</span> <span class="nv">$vaultName</span> <span class="n">-Name</span> <span class="nv">$pass</span><span class="p">).</span><span class="n">SecretValueText</span>
<span class="nv">$secpasswd</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="nv">$password</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>

<span class="cm">&lt;# This can be skipped if not needed #&gt;</span>
<span class="nv">$date</span> <span class="p">=</span> <span class="nb">get-date</span>
<span class="nv">$dateExpire</span> <span class="p">=</span> <span class="nv">$date</span><span class="p">.</span><span class="n">AddDays</span><span class="p">(</span><span class="n">35</span><span class="p">)</span>

<span class="nb">New-LocalUser</span> <span class="n">-Name</span> <span class="nv">$username</span> <span class="n">-Password</span> <span class="nv">$secpasswd</span> <span class="n">-AccountExpires</span> <span class="nv">$dateExpire</span>

<span class="nb">Add-LocalGroupMember</span> <span class="n">-Group</span> <span class="s2">&#34;Administrators&#34;</span> <span class="n">-Member</span> <span class="nv">$username</span></code></pre></div>
</details>
<p>If you have a certain naming convention for Username and Password data in KeyVault, you can grab multiple secrets and with a simple &ldquo;foreach&rdquo; push n users to a VM.
Smooth, isn&rsquo;t it :)</p>
<p>Listening to some great talks on numerous Azure meetups and online conferences in the past 2 months of WFH, I came to an additional idea - I will try to use Azure Functions to trigger user creation/update on certain changes in KeyVault. Interested if that is possible? Me to :)</p>
<p>Stay tuned and stay healthy!</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>The article was updated on 2020-05-09</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/mighty_azure_portal_vol1/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://doctorsolution.xyz/mighty_azure_portal_vol1/" data-title="Mighty Azure portal vol1" data-via="MilosKatinski" data-hashtags="Azure,PowerShell"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://doctorsolution.xyz/mighty_azure_portal_vol1/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://doctorsolution.xyz/mighty_azure_portal_vol1/"><i class="fab fa-reddit fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/azure/">Azure</a>,&nbsp;<a href="/tags/powershell/">PowerShell</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/azure_application_gateway_reconfiguration/" class="prev" rel="prev" title="Azure Application Gateway Reconfiguration"><i class="fas fa-angle-left fa-fw"></i>Azure Application Gateway Reconfiguration</a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.70.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.6"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Milos Katinski</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript">
    window.config = {"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"headerMode":{"desktop":"fixed","mobile":"auto"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};
</script><script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=html5shiv%2CElement.prototype.closest%2CrequestAnimationFrame%2CCustomEvent%2CPromise%2CObject.entries%2CObject.assign%2CObject.values%2Cfetch%2CElement.prototype.after%2CArray.prototype.fill%2CIntersectionObserver%2CArray.from%2CArray.prototype.find%2CMath.sign"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/object-fit-images/ofi.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
